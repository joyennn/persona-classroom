<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>Persona Classroom Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --brand:#2563eb; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background:var(--bg); color:var(--text);}
    .container { max-width: 1080px; margin: 32px auto; padding: 0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .section { padding:18px; }
    h1 { margin:0 0 12px; font-size:28px; }
    h2 { margin:0 0 12px; font-size:22px; }
    h3 { margin:0 0 8px; font-size:18px; }
    .row { display:flex; gap:12px; align-items:stretch; }
    .col { flex:1; display:flex; flex-direction:column; gap:10px; }
    input[type=text], input[type=password], textarea {
      width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; outline:none; background:#fff; font-size:14px;
    }
    input:focus, textarea:focus { border-color:var(--brand); }
    button { background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
    .pill { font-size:12px; color:var(--muted); }
    .hero { display:flex; gap:18px; align-items:center; }
    .hero img { width:320px; height:320px; object-fit:cover; border-radius:14px; border:1px solid var(--border); }
    .hero .desc { display:flex; flex-direction:column; gap:8px; }
    #chat { height:520px; overflow-y:auto; background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
    .msg { margin:10px 0; line-height:1.55; }
    .who { font-weight:700; margin-right:6px; }
    .system { color:#6b7280; }
    .user { color:#0ea5e9; }
    .assistant { color:#374151; }
    .meta { font-size:12px; color:var(--muted); margin-left:6px; }
    .typing { font-style:italic; color:var(--muted); }
    /* 페르소나 카드 영역 */
    .personaGrid { display:flex; flex-wrap:wrap; gap:16px; }
    .personaCard { border:1px solid var(--border); border-radius:14px; padding:12px; width:320px; background:#fff; }
    .personaCard img { width:100%; height:300px; object-fit:cover; border-radius:10px; border:1px solid var(--border); }
    .personaHeader { display:flex; align-items:center; gap:8px; margin-top:10px; }
    .chip { display:flex; gap:6px; align-items:center; border:1px solid var(--border); padding:6px 10px; border-radius:10px; background:#fff; }
    .chips { display:flex; gap:10px; flex-wrap:wrap; }
    .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Persona Classroom Chat</h1>

    <!-- 1) 사용자 API 키 입력/검증 -->
    <div class="card section" id="keyCard">
      <h2>1) OpenAI API 키</h2>
      <div class="row" style="align-items:center;">
        <div class="col">
          <input id="apiKey" type="password" placeholder="sk- 로 시작하는 OpenAI API 키를 입력하세요"/>
          <span class="muted">키는 이 브라우저에서만 사용되며 서버에 저장되지 않습니다. (새로고침 시 재입력 필요)</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="verifyBtn">키 확인</button>
          <span id="keyStatus" class="pill"></span>
        </div>
      </div>
    </div>

    <!-- 2) 소개(대표 이미지 + 짧은 설명) -->
    <div class="card section" id="introCard" style="display:none;">
      <h2>2) 수업 장면 소개</h2>
      <div class="hero">
        <!-- 대표 이미지: 교사 이미지(또는 원하는 소개 이미지) -->
        <img id="heroImg" src="/static/teacher.jpg" alt="교실 장면"/>
        <div class="desc">
          <strong>교실 시뮬레이션</strong>
          <p class="muted">
            이 페이지에서는 선생님과 여러 학생 페르소나를 선택해 실제 수업처럼 대화를 나눌 수 있어요.
            각 학생은 서로 다른 말투/성향을 지니며, 매 턴마다 선택한 인물만 발화하도록 제어할 수도 있습니다.
          </p>
          <ul class="muted" style="margin:0; padding-left:18px;">
            <li>이미지: 교실/인물 대표 이미지</li>
            <li>텍스트: 짧은 설명(수업 목표, 대화 규칙 등)을 표시</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 3) 에이전트/학생 구성 (이미지 크게 + 설명 + 체크박스) -->
    <div class="card section" id="personaCard" style="display:none;">
      <div class="toolbar">
        <h2>3) 에이전트/학생 구성</h2>
        <span class="muted">장면에 포함할 인물을 체크하세요. (교사 + 원하는 학생들)</span>
      </div>
      <div id="personaList" class="personaGrid"></div>
    </div>

    <!-- 4) 대화 -->
    <div class="card section" id="chatCard" style="display:none;">
      <div class="toolbar">
        <h2>4) 대화</h2>
        <div class="chips">
          <button id="saveBtn">대화 저장</button>
          <button id="newBtn">새 대화</button>
        </div>
      </div>

      <!-- 이번 턴 발화자 선택 (비워두면 모델이 소수만 선택) -->
      <div id="respondersBox" class="row" style="gap:12px; align-items:center; margin-bottom:10px;">
        <div class="muted">이번 턴 발화자(선택):</div>
        <div id="respondersChecks" class="chips"></div>
      </div>

      <div id="chat"></div>

      <div class="row" style="margin-top:12px;">
        <input id="message" type="text" placeholder="메시지를 입력하고 Enter 또는 전송 클릭"/>
        <button id="sendBtn" disabled>전송</button>
      </div>
      <div id="status" class="muted" style="margin-top:6px;"></div>
    </div>
  </div>

  <!-- 스크립트는 body 맨 끝 + DOMContentLoaded로 감쌈 -->
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const API_VERIFY   = "/verify-key";
    const API_CHAT     = "/chat";
    const API_PERSONAS = "/personas";

    let apiKey = "";
    let verified = false;
    let sending = false;
    let conversation = [];         // user/assistant 메시지만 쌓아도 됨
    let allPersonas = [];          // 서버에서 받은 전체 페르소나
    let activePersonaIds = [];     // 장면(Scene)에 포함할 인물들
    let respondersThisTurn = [];   // 이번 턴 실제로 말할 인물(선택 시)

    // ─ helpers ─
    const el = id => document.getElementById(id);
    const now = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const escapeHtml = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function addMessage(role, text) {
      const box = el('chat');
      const d = document.createElement('div');
      d.className = 'msg';
      const who = document.createElement('span');
      who.className = `who ${role}`;
      who.textContent = role === 'user' ? '나' : (role === 'assistant' ? 'Agent' : 'System');
      const time = document.createElement('span');
      time.className = 'meta';
      time.textContent = now();
      const content = document.createElement('span');
      content.innerHTML = " : " + escapeHtml(text).replace(/\n/g,"<br/>");
      d.appendChild(who); d.appendChild(time); d.appendChild(content);
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }
    function setStatus(t) { const s = el('status'); if (s) s.textContent = t ?? ""; }
    function toggleSending(flag) {
      sending = flag;
      const sendBtn = el('sendBtn'), msg = el('message');
      if (sendBtn) sendBtn.disabled = flag || !verified;
      if (msg) msg.disabled = flag || !verified;
      setStatus(flag ? "에이전트가 응답 중…" : "");
    }

    // 필수 요소 확인
    if (!el('verifyBtn') || !el('apiKey')) {
      alert('페이지 로딩 문제: verifyBtn/apiKey 요소가 없습니다. index.html 최신본이 맞는지 확인하세요.');
      return;
    }

    // 1) 키 검증
    el('verifyBtn').addEventListener('click', async () => {
      const key = el('apiKey').value.trim();
      if (!key) { alert("API 키를 입력하세요."); return; }
      el('verifyBtn').disabled = true;
      const ks = el('keyStatus'); if (ks) ks.textContent = "검증 중…";

      try {
        const r = await fetch(API_VERIFY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key })
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          if (ks) ks.textContent = "❌ 실패";
          alert(j.detail || "API 키 검증 실패");
          el('verifyBtn').disabled = false;
          return;
        }
        apiKey = key; verified = true;
        if (ks) ks.textContent = "✔️ 확인됨";
        el('verifyBtn').disabled = true;

        // UI 오픈 + 소개/페르소나 로딩
        el('introCard').style.display = "";
        el('personaCard').style.display = "";
        el('chatCard').style.display = "";
        el('sendBtn').disabled = false;
        el('message').disabled = false;

        await loadPersonas();
      } catch (e) {
        if (ks) ks.textContent = "❌ 오류";
        alert("네트워크 오류");
        el('verifyBtn').disabled = false;
      }
    });

    // 2) 페르소나 로딩 + 카드 렌더링
    async function loadPersonas() {
      const r = await fetch(API_PERSONAS);
      const j = await r.json();
      allPersonas = j.personas || [];

      const list = document.getElementById("personaList");
      list.innerHTML = "";
      allPersonas.forEach(p => {
        const card = document.createElement("div");
        card.className = "personaCard";
        card.innerHTML = `
          <img src="${p.image_url}" alt="${p.name}" />
          <div class="personaHeader">
            <input type="checkbox" class="personaCheck" data-id="${p.id}">
            <strong>${p.name}</strong>
            <span class="muted">(${p.role})</span>
          </div>
          <div class="muted" style="font-size:13px; margin-top:6px;">${p.short_desc}</div>
        `;
        list.appendChild(card);
      });

      // 기본: 교사 자동 체크
      const teacher = allPersonas.find(p => p.id === "teacher");
      if (teacher) {
        const chk = list.querySelector(`.personaCheck[data-id="${teacher.id}"]`);
        if (chk) chk.checked = true;
      }
      refreshActivePersonas();
    }

    function refreshActivePersonas() {
      activePersonaIds = Array.from(document.querySelectorAll(".personaCheck"))
        .filter(x => x.checked)
        .map(x => x.getAttribute("data-id"));
      renderResponderChecks(); // 발화자 선택 박스도 갱신
    }

    function renderResponderChecks() {
      const box = document.getElementById("respondersChecks");
      box.innerHTML = "";
      const active = allPersonas.filter(p => activePersonaIds.includes(p.id));
      active.forEach(p => {
        const wrap = document.createElement("label");
        wrap.className = "chip";
        wrap.innerHTML = `<input type="checkbox" class="responderCheck" data-id="${p.id}"><span>${p.name}</span>`;
        box.appendChild(wrap);
      });
      respondersThisTurn = []; // 초기화
    }

    document.addEventListener("change", (e) => {
      if (e.target.classList.contains("personaCheck")) {
        refreshActivePersonas();
      }
      if (e.target.classList.contains("responderCheck")) {
        const id = e.target.getAttribute("data-id");
        if (e.target.checked) {
          if (!respondersThisTurn.includes(id)) respondersThisTurn.push(id);
        } else {
          respondersThisTurn = respondersThisTurn.filter(x => x !== id);
        }
      }
    });

    // 3) 채팅 전송 (버튼/Enter)
    el('sendBtn').addEventListener('click', send);
    el('message').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    async function send() {
      if (!verified || sending) return;
      const msg = el('message').value.trim();
      if (!msg) return;

      addMessage('user', msg);
      conversation.push({ role: "user", content: msg });
      el('message').value = "";
      toggleSending(true);

      // 타이핑 표시
      const typing = document.createElement('div');
      typing.className = 'msg typing';
      typing.textContent = "Agent가 입력 중…";
      el('chat').appendChild(typing);
      el('chat').scrollTop = el('chat').scrollHeight;

      try {
        const payload = {
          api_key: apiKey,
          conversation,
          model: "gpt-4o-mini",
          temperature: 0.7,
          max_turns: 16,
          active_persona_ids: activePersonaIds,
          responders_this_turn: respondersThisTurn.length ? respondersThisTurn : null
        };
        const r = await fetch(API_CHAT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        typing.remove();

        if (!r.ok) {
          addMessage('assistant', `❌ ${j.detail || "서버 오류"}`);
          return;
        }
        addMessage('assistant', j.reply);
        conversation.push({ role: "assistant", content: j.reply });
      } catch (e) {
        typing.remove();
        addMessage('assistant', '❌ 서버 연결 오류');
      } finally {
        toggleSending(false);
      }
    }

    // 4) 저장/새 대화
    el('saveBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(conversation, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `conversation_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    el('newBtn').addEventListener('click', () => {
      if (!confirm("현재 대화를 지우고 새로 시작할까요?")) return;
      conversation = [];
      el('chat').innerHTML = "";
      setStatus("");
      // 발화자 선택은 유지 (원하면 respondersThisTurn = []로 초기화 가능)
    });
  });
  </script>
</body>
</html>
