<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>Persona Classroom Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --brand:#2563eb; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background:var(--bg); color:var(--text);}
    .container { max-width: 1080px; margin: 32px auto; padding: 0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .section { padding:18px; }
    h1 { margin:0 0 12px; font-size:28px; }
    h2 { margin:0 0 12px; font-size:22px; }
    h3 { margin:0 0 8px; font-size:18px; }
    .row { display:flex; gap:12px; align-items:stretch; }
    .col { flex:1; display:flex; flex-direction:column; gap:10px; }
    input[type=text], input[type=password], textarea {
      width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; outline:none; background:#fff; font-size:14px;
    }
    input:focus, textarea:focus { border-color:var(--brand); }
    button { background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
    .pill { font-size:12px; color:var(--muted); }
    .hero { display:flex; gap:18px; align-items:center; }
    .hero img { width:320px; height:320px; object-fit:cover; border-radius:14px; border:1px solid var(--border); }
    .hero .desc { display:flex; flex-direction:column; gap:8px; }
    #chat { height:520px; overflow-y:auto; background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
    .msg { margin:10px 0; line-height:1.55; }
    .who { font-weight:700; margin-right:6px; }
    .system { color:#6b7280; }
    .user { color:#0ea5e9; }
    .assistant { color:#374151; }
    .meta { font-size:12px; color:var(--muted); margin-left:6px; }
    .typing { font-style:italic; color:var(--muted); }

    /* 페르소나 카드 영역 */
    .personaGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 9px;
    }

    .personaCard {
      flex: 0 0 calc(20% - 10px); /* 100% ÷ 5 = 20% */
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: #fff;
    }

    .personaCard img {
      width: 100%;
      aspect-ratio: 3/4;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .personaHeader { display:flex; align-items:center; gap:8px; margin-top:10px; }
    .chip { display:flex; gap:6px; align-items:center; border:1px solid var(--border); padding:6px 10px; border-radius:10px; background:#fff; }
    .chips { display:flex; gap:10px; flex-wrap:wrap; }
    .toolbar { 
      display:flex; 
      align-items:center; 
      justify-content:flex-start;  /* ← space-between 대신 */
      gap:12px; 
    }
    /* 오른쪽 그룹을 자동 오른쪽 정렬 */
    .toolbar .right { 
      margin-left:auto; 
      display:flex; 
      gap:8px; 
    }
    /* 보조설명은 툴바 아래 한 줄 */
    .subbar {
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    /* 카드가 자식 넘침을 잘라내도록 (둥근 모서리 밖으로 안 튀게) */
    .card { overflow: hidden; }

    /* 툴바는 한 줄(필요시 다음 줄로 감싸기) */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:flex-start; /* 왼쪽 정렬 기본 */
      gap:12px;
      flex-wrap:wrap;             /* 좁은 화면에서 줄바꿈 허용 */
      width:100%;
    }

    /* 오른쪽 버튼 그룹: 왼쪽 요소와 간격 벌리고 우측 정렬 */
    .toolbar .right{
      margin-left:auto;           /* 핵심: 오른쪽으로 밀기 */
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;             /* 폭이 좁을 때 버튼이 아래로 접힘 */
    }

    /* 대화창이 부모 폭을 넘지 않도록 */
    #chat{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }

    /* 혹시 버튼을 chip 스타일로 쓴다면 글자색 보장 */
    .toolbar .right button{ color:#fff; }
    #chat .meta { display: none !important; }

    
  </style>
</head>


<body>
  <div class="container">
    <h1>AI agent platform for CLIL</h1>

    <!-- 1) 사용자 API 키 입력/검증 -->
    <div class="card section" id="keyCard">
      <h2>1) API key (Claude 3.5 sonnet)</h2>
      <div class="row" style="align-items:center;">
        <div class="col">
          <input id="apiKey" type="password" placeholder="Enter an Anthropic API key starting with 'sk-'">
          <span class="muted">The key is only used in this browser and is not stored on the server. (Re-enter required upon refresh)</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="verifyBtn">Confirm</button>
          <span id="keyStatus" class="pill"></span>
        </div>
      </div>
    </div>

    <!-- 2) 소개(대표 이미지 + 짧은 설명) -->
    <div class="card section" id="introCard" style="display:none;">
      <h2>2) Classroom</h2>
      <div class="hero">
        <!-- 대표 이미지: 교사 이미지(또는 원하는 소개 이미지) -->
        <img id="heroImg" src="/static/teacher.jpg" alt="classroom image"/>
        <div class="desc">
          <strong>Instruction</strong>
          <p class="muted">
            <ul class="muted" style="margin:0; padding-left:18px;">
            <li>This CLIL simulation takes place in a 2nd-grade elementary school classroom.
            <li>The class is led by a native Korean teacher.</li>
            <li>The class consists of 15 multicultural students from diverse national backgrounds. </li>
            <li>Each student has different levels of subject knowledge and language proficiency depending on their background.</li>
            <li>As the user, you will take on the role of the 'teacher' and simulate how such a class environment unfolds.</li>
          </ul>
        </p>   
        </div>
      </div>
    </div>

    <!-- 3) 에이전트/학생 구성 (이미지 크게 + 설명 + 체크박스) -->
<div class="card section" id="personaCard" style="display:none;">
  <div class="toolbar">
    <h2>3) Agents (Students)</h2>
    <div class="right">
      <button id="selectAllBtn" type="button">Check all</button>
      <button id="clearAllBtn"  type="button">Uncheck</button>
    </div>
  </div>

  <div class="subbar">Check the agents included in the chat.</div>

  <!-- 반드시 card 안쪽에 있어야 함 -->
  <div id="personaList" class="personaGrid" style="margin-top:10px;"></div>
</div>

    

<!-- 4) 대화 -->
<div class="card section" id="chatCard" style="display:none;">
  <div class="toolbar">
    <h2>4) Chat</h2>
    <div class="right">
      <select id="langSel" class="chip">
        <option value="auto" selected>Language Select</option>
        <option value="ko">Korean</option>
        <option value="en">English</option>
      </select>
      <button id="saveBtn">Save chat</button>
      <button id="newBtn">New chat</button>
    </div>
  </div>

  <!-- 나머지 요소들은 그대로 카드 내부에 유지 -->
  <div id="respondersBox" class="row" style="gap:12px; align-items:center; margin-bottom:10px;">
    <div class="muted">Agents included</div>
    <div id="respondersChecks" class="chips"></div>
  </div>

  <div id="chat"></div>

  <div class="row" style="margin-top:12px;">
    <input id="message" type="text" placeholder="Type your message and press Enter or click Send."/>
    <button id="sendBtn" disabled>Send</button>
  </div>
  <div id="status" class="muted" style="margin-top:6px;"></div>
</div>


  <!-- 스크립트는 body 맨 끝 + DOMContentLoaded로 감쌈 -->
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const API_VERIFY   = "/verify-key";
    const API_CHAT     = "/chat";
    const API_PERSONAS = "/personas";

    let apiKey = "";
    let verified = false;
    let sending = false;
    let conversation = [];         // user/assistant 메시지만 쌓아도 됨
    let transcript  = [];
    let allStudents = [];          // 서버에서 받은 전체 학생
    let activePersonaIds = [];     // 장면(Scene)에 포함할 학생들(student_id)
    let respondersThisTurn = [];   // 이번 턴 실제로 말할 인물(선택 시)

    // ─ helpers ─
    const el = id => document.getElementById(id);
    const now = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const escapeHtml = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function addMessage(role, text) {
    const box = el('chat');
    const d = document.createElement('div');
    d.className = 'msg';

    if (role === 'user' || role === 'system') {
      const who = document.createElement('span');
      who.className = `who ${role}`;
      who.textContent = role === 'user' ? '나' : 'System';

      const content = document.createElement('span');
      content.innerHTML = ' : ' + escapeHtml(text).replace(/\n/g, '<br/>');

      d.appendChild(who);
      d.appendChild(content);
    } else {
      // assistant: 이름은 모델 응답의 [이름]: ... 형식으로 들어오므로 그대로 출력
      const content = document.createElement('span');
      content.innerHTML = escapeHtml(text).replace(/\n/g, '<br/>');
      d.appendChild(content);
    }

    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  }
    function setStatus(t) { const s = el('status'); if (s) s.textContent = t ?? ""; }
    function toggleSending(flag) {
      sending = flag;
      const sendBtn = el('sendBtn'), msg = el('message');
      if (sendBtn) sendBtn.disabled = flag || !verified;
      if (msg) msg.disabled = flag || !verified;
      setStatus(flag ? "에이전트가 응답 중…" : "");
    }


    // 필수 요소 확인
    if (!el('verifyBtn') || !el('apiKey')) {
      alert('페이지 로딩 문제: verifyBtn/apiKey 요소가 없습니다. index.html 최신본이 맞는지 확인하세요.');
      return;
    }

    // 1) 키 검증
    el('verifyBtn').addEventListener('click', async () => {
      const key = el('apiKey').value.trim();
      if (!key) { alert("API 키를 입력하세요."); return; }
      el('verifyBtn').disabled = true;
      const ks = el('keyStatus'); if (ks) ks.textContent = "검증 중…";

      try {
        const r = await fetch(API_VERIFY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key })
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) {
          if (ks) ks.textContent = "❌ 실패";
          alert(j.detail || "API 키 검증 실패");
          el('verifyBtn').disabled = false;
          return;
        }
        apiKey = key; verified = true;
        if (ks) ks.textContent = "✔️ 확인됨";
        el('verifyBtn').disabled = true;

        // UI 오픈 + 소개/페르소나 로딩
        el('introCard').style.display = "";
        el('personaCard').style.display = "";
        el('chatCard').style.display = "";
        el('sendBtn').disabled = false;
        el('message').disabled = false;

        await loadPersonas();
      } catch (e) {
        if (ks) ks.textContent = "❌ 오류";
        alert("네트워크 오류");
        el('verifyBtn').disabled = false;
      }
    });

    // 2) 페르소나 로딩 + 카드 렌더링
    async function loadPersonas() {
    const r = await fetch(API_PERSONAS);
    const j = await r.json().catch(() => ({}));

    // 1) 우선순위: 새 스키마 students
    let raw = j?.students ?? j?.personas ?? [];
    // 2) 객체(map)로 왔으면 배열로 변환
    if (!Array.isArray(raw)) raw = Object.values(raw);
    // 3) 예전 personas 스키마면 student 전용으로 변환
    let parsed = raw;
    if (!j?.students && j?.personas) {
      parsed = raw
        .filter(p => p.role === 'student')
        .map(p => ({
          student_id: p.id,
          name: p.name,
          country: p.country || "",
          summary: p.short_desc || "",
          photo_url: p.image_url || ""
        }));
    }

    allStudents = parsed;
    console.log("[UI] Loaded students:", allStudents.length, allStudents);

    const list = document.getElementById("personaList");
    list.innerHTML = "";
    allStudents.forEach(p => {
      const imgSrc = p.photo_url || `/static/students/${p.student_id}.jpg`;
      const info = parseSummary(p.summary || "");
      const card = document.createElement("div");
      card.className = "personaCard";
      card.innerHTML = `
        <img src="${imgSrc}" alt="${p.name}"
             onerror="this.onerror=null;this.src='/static/student-placeholder.jpg';"/>
        <div class="personaHeader">
          <input type="checkbox" class="personaCheck" data-id="${p.student_id}">
          <strong>${p.name}</strong>
          <span class="muted">· ${p.country ?? ""}</span>
        </div> 
      `;
      list.appendChild(card);
    });

    refreshActivePersonas();
  }

    function refreshActivePersonas() {
      activePersonaIds = Array.from(document.querySelectorAll(".personaCheck"))
        .filter(x => x.checked)
        .map(x => x.getAttribute("data-id"));
      renderResponderChecks(); // 발화자 선택 박스도 갱신
      // 아무도 선택 안 되면 전송 비활성화 및 안내
      const canSend = verified && activePersonaIds.length > 0;
      el('sendBtn').disabled = !canSend || sending;
      el('message').disabled = !canSend || sending;
      if (!canSend) setStatus("Check at least 1 agent.");
      else setStatus("");
    }

    function renderResponderChecks() {
      const box = document.getElementById("respondersChecks");
      box.innerHTML = "";
      const active = allStudents.filter(p => activePersonaIds.includes(p.student_id));
      active.forEach(p => {
        const wrap = document.createElement("label");
        wrap.className = "chip";
        wrap.innerHTML = `<input type="checkbox" class="responderCheck" data-id="${p.student_id}"><span>${p.name}</span>`;
        box.appendChild(wrap);
      });
      respondersThisTurn = []; // 초기화
    }

    document.addEventListener("change", (e) => {
      if (e.target.classList.contains("personaCheck")) {
        refreshActivePersonas();
      }
      if (e.target.classList.contains("responderCheck")) {
        const id = e.target.getAttribute("data-id");
        if (e.target.checked) {
          if (!respondersThisTurn.includes(id)) respondersThisTurn.push(id);
        } else {
          respondersThisTurn = respondersThisTurn.filter(x => x !== id);
        }
      }
    });

    // 모두 선택
if (document.getElementById('selectAllBtn')) {
  document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.personaCheck').forEach(chk => chk.checked = true);
    refreshActivePersonas(); // 선택 반영 + 발화자 박스 갱신 + 전송버튼 활성화
  });
}

// 모두 해제
if (document.getElementById('clearAllBtn')) {
  document.getElementById('clearAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.personaCheck').forEach(chk => chk.checked = false);
    refreshActivePersonas(); // 선택 해제 반영
  });
}

    // 3) 채팅 전송 (버튼/Enter)
    el('sendBtn').addEventListener('click', send);
    el('message').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    async function send() {
      if (!verified || sending) return;
      if (activePersonaIds.length === 0) {
        setStatus("학생을 최소 1명 선택하세요.");
        return;
      }
      const msg = el('message').value.trim();
      if (!msg) return;

      addMessage('user', msg);
      conversation.push({ role: "user", content: msg });
      transcript.push({  role: "user", content: msg });    // 저장용
      el('message').value = "";
      toggleSending(true);

      // 타이핑 표시
      const typing = document.createElement('div');
      typing.className = 'msg typing';
      typing.textContent = "Agent가 입력 중…";
      el('chat').appendChild(typing);
      el('chat').scrollTop = el('chat').scrollHeight;

      try {
        const payload = {
          api_key: apiKey,
          conversation,
          model: "claude-3-5-sonnet-20240620",
          temperature: 0.7,
          max_turns: 16,
          active_persona_ids: activePersonaIds,
          responders_this_turn: respondersThisTurn.length ? respondersThisTurn : null,
          lang: (el('langSel')?.value ?? 'auto')        
        };
        const r = await fetch(API_CHAT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        typing.remove();

        if (!r.ok) {
          addMessage('assistant', `❌ ${j.detail || "서버 오류"}`);
          return;
        }
        // addMessage('assistant', j.reply);

        // 응답 본문을 안전하게 문자열화 (있으면)
        const replyText = (typeof j.reply === "string") ? j.reply : JSON.stringify(j.reply);

        // 화면에 출력
        addMessage('assistant', replyText);

        conversation.push({ role: "assistant", content: replyText });  // ✅ 항상 assistant로

        // 저장용(transcript)에는 학생이름으로 파싱해 기록
        const m = replyText.match(/^\s*\[([^\]]+)\]\s*:\s*(.*)$/s);
        if (m) {
          transcript.push({ role: m[1], content: m[2].trim() });
        } else {
          transcript.push({ role: "assistant", content: replyText });
        }
      } catch (e) {
        typing.remove();
        addMessage('assistant', '❌ 서버 연결 오류');
      } finally {
        toggleSending(false);
      }
    }

    // 4) 저장/새 대화
    el('saveBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(transcript, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `conversation_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    el('newBtn').addEventListener('click', () => {
      if (!confirm("현재 대화를 지우고 새로 시작할까요?")) return;
      conversation = [];
      transcript  = [];
      el('chat').innerHTML = "";
      setStatus("");
      // 발화자 선택은 유지 (원하면 respondersThisTurn = []로 초기화 가능)
    });
  });


  function levelLabel(n) {
  const map = { "1":"초급1", "2":"초급2", "3":"중급", "4":"상급", "5":"최상" };
  return map[String(n)] || String(n);
}

// "- [이름 / ID / 국가]: KOR L/S/R/W=2/1/2/1, 동기=1, 성향=a, b, c, 선호=x, y, 어려움=z" 형태를 파싱
function parseSummary(summary) {
  const out = { L:null, S:null, R:null, W:null, motivation:null, traits:[], favorite:[], struggle:[] };
  if (!summary) return out;

  // L/S/R/W
  const mLSRW = summary.match(/KOR\s+L\/S\/R\/W\s*=\s*([0-9?])\/([0-9?])\/([0-9?])\/([0-9?])/i);
  if (mLSRW) [out.L, out.S, out.R, out.W] = [mLSRW[1], mLSRW[2], mLSRW[3], mLSRW[4]];

  // 동기
  const mMot = summary.match(/동기\s*=\s*([0-9]+)/);
  if (mMot) out.motivation = mMot[1];

  // 성향
  const mTraits = summary.match(/성향\s*=\s*([^,]+(?:,\s*[^,]+)*)/);
  if (mTraits) out.traits = mTraits[1].split(/\s*,\s*/).filter(Boolean);

  // 선호
  const mFav = summary.match(/선호\s*=\s*([^,]+(?:,\s*[^,]+)*)/);
  if (mFav) out.favorite = mFav[1].split(/\s*,\s*/).filter(Boolean);

  // 어려움
  const mStr = summary.match(/어려움\s*=\s*(.+)$/);
  if (mStr) out.struggle = mStr[1].split(/\s*,\s*/).map(s => s.trim()).filter(Boolean);

  return out;
}

// 어떤 값이 와도 화면에 표시 가능한 문자열로 변환
function toText(x) {
  if (x == null) return "";
  if (typeof x === "string") return x;
  if (x instanceof Error) return x.message || String(x);
  if (typeof x === "object") {
    // 흔한 케이스 우선 추출
    if (typeof x.text === "string") return x.text;
    if (typeof x.message === "string") return x.message;
    if (typeof x.content === "string") return x.content;
    try { return JSON.stringify(x, null, 2); } catch { return String(x); }
  }
  return String(x);
}

  </script>
</body>
</html>
